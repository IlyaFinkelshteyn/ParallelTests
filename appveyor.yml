version: 1.0.{build}

environment:
  API_KEY:
    secure: YIuqOcciVmoaQJhMWRoknEDuDMTUJ+oMnHCXQmBlgv4=
  TimeOutMins: 5
    
install:
- cmd: nuget restore

build:
  verbosity: minimal

test:
  categories:
  - - C1
  - - C2
  - - C3
  - - C4

before_deploy:
- ps: | 

if ($env:APPVEYOR_JOB_NUMBER -ne 1) {return}

[datetime]$stop = ([datetime]::Now).AddMinutes($TimeOutMins)
[bool]$success = $false

while(!$success -and ([datetime]::Now) -lt $stop) {

    $project = Invoke-RestMethod -Uri "https://ci.appveyor.com/api/projects/$AccountName/$ProjectSlug" -Headers $headers -Method GET

    $project.build.jobs | foreach-object {$_.status}
    
    $success = $false # todo
    if (!$success) {
Start-sleep 5
    }
}

if (!$success) {
    throw "Test jobs were not finished in $TimeOutMins minutes"
}


