version: 1.0.{build}

environment:
  API_KEY:
    secure: YIuqOcciVmoaQJhMWRoknEDuDMTUJ+oMnHCXQmBlgv4=
  TimeOutMins: 1
    
install:
- cmd: nuget restore

build:
  verbosity: minimal

test:
  categories:
  - - C1
  - - C2
  - - C3
  - - C4

after_test:
- ps: "if ($env:APPVEYOR_JOB_NUMBER -ne 1) {return}\n\nwrite-host \"Waiting for other jobs to complete\"\n\n\n$headers = @{\n  \"Authorization\" = \"Bearer $ApiKey\"\n \"Content-type\" = \"application/json\"\n}\n\n[datetime]$stop = ([datetime]::Now).AddMinutes($env:TimeOutMins)\n[bool]$success = $false\n\nwhile(!$success -and ([datetime]::Now) -lt $stop) {\n\n    $project = Invoke-RestMethod -Uri \"https://ci.appveyor.com/api/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG\" -Headers $headers -Method GET\n\n    $project.build.jobs | foreach-object {$_.status; $_ | convertto-json}\n    \n    $success = $false # todo\n    if (!$success) {Start-sleep 5}\n}\n\nif (!$success) {throw \"Test jobs were not finished in $env:TimeOutMins minutes\"}"
